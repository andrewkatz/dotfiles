#!/usr/bin/env bash

set -e

source "$(dirname "$0")/lib/logging.sh"
source "$(dirname "$0")/clean-broken-symlinks"

install_package_manager() {
  if [ "$(uname)" = "Darwin" ]; then
    if [ -z "$(command -v brew)" ]; then
      log "Homebew not found, installing..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
  elif [ "$(uname)" = "Linux" ]; then
    if [ -z "$(command -v yay)" ]; then
      log "yay not found, installing..."
      sudo pacman -S --noconfirm --needed git base-devel
      git clone https://aur.archlinux.org/yay.git /tmp/yay
      pushd /tmp/yay
      makepkg -si
      popd
      rm -rf /tmp/yay
    fi
  else
    log_error "Unsupported OS"
    exit 1
  fi
}

install_stow() {
  if [ -z "$(command -v stow)" ]; then
    log "stow not found, installing..."
    if [ "$(uname)" = "Darwin" ]; then
      brew install stow
    elif [ "$(uname)" = "Linux" ]; then
      yay -S --noconfirm stow
    else
      log_error "Unsupported OS for stow installation"
      exit 1
    fi
  fi
}

change_shell_to_zsh() {
  if [[ "$SHELL" != *"zsh" ]]; then
    if [ -z "$(command -v zsh)" ]; then
      log "zsh not found, installing..."
      if [ "$(uname)" = "Darwin" ]; then
        brew install zsh
      elif [ "$(uname)" = "Linux" ]; then
        yay -S --noconfirm zsh
      else
        log_error "Unsupported OS for zsh installation"
        exit 1
      fi
    fi

    log "Changing default shell to zsh..."
    chsh -s /usr/bin/zsh
    log "Default shell changed to zsh. Please logout and login again for changes to take effect."
    exit
  fi
}

init_tpm() {
  if [ ! -d "$HOME/.config/tmux/plugins" ] ; then
    log "Initializing Tmux Plugin Manager (TPM)..."
    git clone https://github.com/tmux-plugins/tpm $HOME/.config/tmux/plugins/tpm
  fi
}

init_goose() {
  if [ ! -d "$HOME/.config/goose" ] ; then
    mkdir -p $HOME/.config/goose
  fi
}

install_package_manager
install_stow
change_shell_to_zsh
init_tpm
init_goose

log "Installing dotfiles using stow..."
stow --verbose=2 --dotfiles --adopt -t $HOME .
clean_broken_symlinks
